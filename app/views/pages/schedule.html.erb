<div class="home-page-holder">
  <div class="home-block-holder">
    <div class="schedule-content-holder">

      <div id="schedule-block" class="schedule-block">
        <h1>SCHEDULE</h1>

        <!-- Combined Season + Week selector -->
        <div class="selector-row">
          <%= form_with url: schedule_path, method: :get, local: true, html: { id: "schedule-filter-form" } do %>
            <div class="season-selector" style="display:inline-block; margin-right:1rem;">
              <label for="season-select"><strong>Select Season:</strong></label>
              <%= select_tag :season,
                             options_for_select(@available_seasons, @season),
                             id: "season-select",
                             onchange: "document.getElementById('schedule-filter-form').submit();" %>
            </div>

            <div class="week-selector" style="display:inline-block;">
              <label for="week-select"><strong>Select Week:</strong></label>
              <%= select_tag :week_number,
                            options_for_select(@weeks.map { |w| [week_label(w), w.number] }, @default_week_number),
                            id: "week-select",
                            onchange: "document.getElementById('schedule-filter-form').submit();" %>

            </div>
          <% end %>
        </div>

        <div class="schedule-tbl-holder">
          <% if @selected_week && !special_week?(@selected_week) %>
            <table class="schedule-tbl">
              <thead>
                <tr>
                  <th>Home Team</th>
                  <th>Score</th>
                  <th>Away Team</th>
                </tr>
              </thead>
              <tbody>
                <% @selected_week.games.each do |game| %>
                  <tr>
                    <td><%= game.home_team.name %></td>
                    <td><%= game.home_score %> vs <%= game.away_score %></td>
                    <td><%= game.away_team.name %></td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          <% end %>
        </div>

        <% if @selected_week && @team_lineups.any? %>

          <% if special_week?(@selected_week) %>
            <h2><%= week_label(@selected_week) %> Results</h2>
            <table class="lineups-summary-tbl">
              <thead>
                <tr>
                  <th>Pos</th>
                  <th>Team</th>
                  <th>Points</th>
                </tr>
              </thead>
              <tbody>
                <% @team_lineups.each_with_index do |lt, index| %>
                  <tr>
                    <td><%= index + 1 %></td>
                    <td><%= lt.team.name %></td>
                    <td><%= lt.points %></td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          <% end %>

          <h2>Team Lineups — <%= week_label(@selected_week) %></h2>
          <table class="lineups-tbl">
            <thead>
              <tr>
                <th>Team</th>
                <th>Points</th>
                <th>Lineup (sorted)</th>
              </tr>
            </thead>
            <tbody>
              <% @team_lineups.each do |lt| %>
                <tr>
                  <td><%= lt.team.name %></td>
                  <td><%= lt.points %></td>
                  <td>
                    <table class="mini-lineup">
                      <thead>
                        <tr>
                          <th>Slot</th>
                          <th>Player</th>
                          <th>% Drafted</th>
                          <th>FPTS</th>
                        </tr>
                      </thead>
                      <tbody>
                        <% lt.normalized_lineup.each do |slot, pname| %>
                          <% s = stat_for_lineup_name(pname, @stats_by_name) %>
                          <tr>
                            <td><%= slot %></td>
                            <td><%= pname %></td>
                            <td><%= format_pct(s&.dig(:pct)) %></td>
                            <td><%= format_fpts(s&.dig(:fpts)) %></td>
                          </tr>
                        <% end %>
                      </tbody>
                    </table>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        <% end %>


        <!-- Drafted Player Stats -->
        <% if @selected_week && @drafted_stats.any? %>
          <h2>Drafted Player Stats — <%= week_label(@selected_week) %></h2>
          <table id="drafted-stats-tbl" class="drafted-stats-tbl">
            <thead>
              <tr>
                <th>Player</th>
                <th>Roster Position</th>
                <th>% Drafted</th>
                <th>FPTS</th>
              </tr>
            </thead>
            <tbody>
              <% @drafted_stats.each do |stat| %>
                <tr>
                  <td><%= stat.player.name %></td>
                  <td><%= stat.roster_position %></td>
                  <td><%= "#{stat.pct_drafted.to_f.round(2)}%" %></td>
                  <td><%= stat.fpts.to_f.round(2) %></td>
                </tr>
              <% end %>
            </tbody>
          </table>
        <% end %>

      </div>

    </div>
  </div>
</div>
